```puml
title **安联微信接入投保流程（优胜美地）**
actor "用户" as user
participant "优胜美地公众号" as gzh
participant "优胜美地健康险页面(H5)" as front
participant "eBaoCloud" as ebao #red
participant "Allianz" as allianz
participant "微信后台" as WeChat
autonumber

group 0) 微信初始流程

user -> gzh: 用户进入优胜美地公众号
activate user
activate gzh

gzh ->  WeChat: 请求微信菜单
activate WeChat
deactivate user

gzh <-- WeChat: 菜单列表
deactivate WeChat

gzh -> gzh: 显示微信菜单
user <-- gzh: 返回微信菜单
deactivate gzh
activate user


user -> gzh: 点击健康险产品菜单
activate gzh
deactivate user

gzh -> ebao: 请求页面 li.ebaocloud.com.cn/ysmd
activate ebao
deactivate gzh

front <-- ebao: 健康险销售页面
deactivate ebao
activate front

end

group 1) 获取当前客户的openid

front -> WeChat: 请求code（参数：开发者appid），返回li.ebaocloud.com.cn/ysmd
activate WeChat

front <-- WeChat: 返回 code
deactivate WeChat

front -> ebao: 请求openId和access token (参数：appid, appsecret, code)
activate ebao

ebao -> WeChat: 请求openId和access token (参数：appid, appsecret, code)
activate WeChat

ebao <-- WeChat: 返回 openId和access token
deactivate WeChat

front <-- ebao: 返回 openId和access token
deactivate ebao

deactivate front

end


group 2) 获取职业列表

front -> ebao: 请求职业列表
activate front
activate ebao

front <-- ebao: 返回职业列表
deactivate ebao

front -> front: 处理职业列表数据，页面展示
deactivate front

end

group 3) 创建订单

user -> front: 输入订单信息（包括手机号）
activate front
activate user

front -> ebao: 校验手机号次数是否到上限
activate ebao

front <-- ebao: 返回手机号是否合格
deactivate ebao

alt 手机号不合格

user <-- front: 展示错误信息，不可以提交订单
deactivate user

else 手机号合格
user <-- front: 展示提交按钮
activate user

user -> front: 提交订单
deactivate user

front -> ebao: 提交订单
activate ebao

ebao -> allianz: 提交订单
activate allianz

ebao <-- allianz: 返回订单生成结果
deactivate allianz

front <-- ebao: 返回订单生成结果
deactivate ebao

user <-- front: 显示订单信息
deactivate front
deactivate user

end

end


group 4) 在线支付

user -> front: 点击支付
activate user
activate front

front -> ebao: 获取支付参数
activate ebao

front <-- ebao: 返回支付参数
deactivate ebao

front -> allianz: 发起支付请求
activate allianz
deactivate front

user <-- allianz: 支付页面
deactivate allianz

user -> allianz: 客户在线支付
activate allianz
deactivate user

alt 支付失败
user <-- allianz: 支付页面
activate user

else 支付成功
ebao <-- allianz: 支付成功（调用 ebaocloud 回调接口）
deactivate allianz
activate ebao

ebao -> ebao: 支付成功，处理
front <-- ebao: 支付成功
deactivate ebao
activate front

user <-- front: 订单支付成功
deactivate front
deactivate user

end

end


```


```puml
title **安联微信接入投保流程（优胜美地）**
actor "用户" as user
participant "优胜美地公众号" as gzh
participant "优胜美地健康险页面(H5)" as front
participant "eBaoCloud-product" as ebaoprod #red
participant "eBaoCloud-proposal" as ebaoproposal #red
participant "eBaoCloud-payment" as ebaopay #red
participant "eBaoCloud-wechat" as ebaowc #red
participant "Allianz" as allianz
participant "微信后台" as WeChat

```
